<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="檐下窗欞斜映枝椏 與你席地對座飲茶">
    <meta name="author" content="Pengyu">

    <title>Example of iOS VoIP Notification / iOS VoIP Notification实例 - A Piece of Sunshine</title>

    <link rel="canonical" href="http://localhost:4000/blog/ios-voip-push-notification.html">

    <!-- Icons -->
    <link rel="shortcut icon" href="/sysimg/favicon.ico">
    <link rel="apple-touch-icon" href="/sysimg/favicon.ico">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Syntax Highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&display=swap" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66863061-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-66863061-1');
    </script>
    
</head>


<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-main" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">A Piece of Sunshine</a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-main">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                    <li>
                        <a href="/pages/about.html">About</a>
                    </li>
                    
                
                    
                    <li>
                        <a href="/pages/archives.html">Archives</a>
                    </li>
                    
                
                    
                    <li>
                        <a href="/pages/people.html">People</a>
                    </li>
                    
                
                    
                    <li>
                        <a href="/pages/projects.html">Projects</a>
                    </li>
                    
                
                    
                    <li>
                        <a href="/pages/reading.html">Reading</a>
                    </li>
                    
                
                    
                    <li>
                        <a href="/pages/tags.html">Tags</a>
                    </li>
                    
                
                    
                    <li>
                        <a href="/pages/travel.html">Travel</a>
                    </li>
                    
                
            </ul>
        </div>
    </div>
</nav>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header {
        background-image: url('/sysimg/autumn2.jpg');
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    
                    <div class="Tags">
                        
                        <a class="tag" href="/tags.html#ios" title="iOS">iOS</a>
                        
                        <a class="tag" href="/tags.html#swift" title="Swift">Swift</a>
                        
                        <a class="tag" href="/tags.html#pushkit" title="PushKit">PushKit</a>
                        
                    </div>
                    
                    <h1>Example of iOS VoIP Notification / iOS VoIP Notification实例</h1>
                    
                    <span class="meta">
                        Posted by Pengyu 
                        on April 20, 2016
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">
                <p>这篇文章翻译整理自Pierre-Marc Airoldi的<a href="http://pierremarcairoldi.com/ios-8-voip-notifications/">iOS 8 VoIP Notifications</a>和<a href="http://stackoverflow.com/a/28562124/5500154">M Penades</a>关于PushKit实现的回答，加入了我自己的文件设定，以及代码的更新，以方便读者更简单便捷的实现PushKit的学习。</p>

<p>在iOS8中，苹果引进了一种可以用在VoIP应用中的新的消息推送，它可以在收到呼叫请求的时候唤醒你的应。通过这种新的推送方式，开发者将不需要再去设置<code class="language-plaintext highlighter-rouge">keep alive handler</code>来保持程序的后台场链接。新的推送将会在后台唤醒程序而不再需要程序一直运行在后台。总之，它将会减少数据流量的使用并且提高电池寿命。</p>

<p>这一切听起来非常棒，但是在看过官方的文档之后，我们并不能了解怎么去实现它。文档中说到：</p>

<p>In iOS 8 and later, voice-over-IP (VoIP) apps register for UIRemoteNotificationTypeVoIP
  remote notifications instead of using this method.</p>

<p>问题在于<code class="language-plaintext highlighter-rouge">UIRemoteNotificationTypeVoIP</code>并不存在。它不存在的原因在于Apple引入了新的推送框架<code class="language-plaintext highlighter-rouge">PushKit</code>来专门处理这一类别的推送。下面让我们看看如何将该框架运用到我们的应用中。</p>

<h2 id="配置">配置</h2>

<p>在开始之前，我们需要做些准备。首先，我们需要一个VoIP Services certificate。我们需要到iOS开发者中心找到Certificates, Identifier &amp; Profiles部分，可以看到如下截图。</p>

<center><img src="/images/voip/image1.png" alt="" width="50%" /></center>

<p>为了能够接收到消息推送我们需要创建一个Identifier。可以通过导航到Identifiers部分，然后单击加号按钮。</p>

<center><img src="/images/voip/image2.png" alt="" width="80%" /></center>

<p>我们还需要指定一个bundle id给你的应用程序，本例中，我们将使用<code class="language-plaintext highlighter-rouge">com.pengyu.voiptest</code>。先不用担心App Services这部分，我们将在后面补充。然后点击Continue，在下一个界面点击Register，完成。</p>

<center><img src="/images/voip/image3.png" alt="" width="80%" /></center>

<p>目前为止我们已经设置好了Identifier部分，然而我们仍需设置消息推送。打开Certificates界面，然后单击加号按钮，并选择VoIP Services Certificate如下：</p>

<center><img src="/images/voip/image4.png" alt="" width="80%" /></center>

<p>我们将会被要求选择一个app id，这里我们下拉菜单中选择我们之前刚刚创建的那个id，点击Continue。下一步要求并告诉我们如何生成一个Certificate Signing Request。</p>

<p>如何生成CSR文件：</p>

<p>打开Keychain Access，在Keychain Access下拉菜单中选择Keychain Access &gt; Certificate Assistant &gt; Request a Certificate from a Certificate Authority.</p>

<p>在证书信息窗口，在User Email Address输入你的邮件地址，在Common Name那里输入一个你的私钥的名字，保持CA Email Address空白。
在”Request is”那里, 选择”Saved to disk” 选项，然后点击Continue，保存CSR到本地文件夹。</p>

<p>下一步就是上传刚刚保存在本地的CSR，然后生存我们所需要的证书。一旦证书成功生产，结果将如下图所示：</p>

<center><img src="/images/voip/image6.png" alt="" width="80%" /></center>

<p>下载该证书并打开它<code class="language-plaintext highlighter-rouge">voip_services.cer</code>，这将会在Keychain Access应用中看到这个证书。目前我们完成了设置，下一步我们可以开始真正的工作了。找到你的certificate并点击证书旁边的小箭头，同时得到certificate和对应的key。
同时选中certificate和key，右击，选择Export 2 items…。</p>

<center><img src="/images/voip/image7.png" alt="" width="80%" /></center>

<p>选择p12格式并命名文件为 certificate.p12。</p>

<p>将 <code class="language-plaintext highlighter-rouge">voip_services.cer</code> 和 <code class="language-plaintext highlighter-rouge">certificate.p12</code>文件保存在同一个文件夹下，方便我们一会儿生成模拟服务器端消息的推送。</p>

<p>最后，在Apple开发者中心找到Provisioning Profiles-&gt;Distribution 点击右上角加号，新建一个Ad-Hoc distribution profile。</p>

<center><img src="/images/voip/image11.png" alt="" width="80%" /></center>

<p>根据向导，选择你的APP ID，开发者账号，以及将要用于真机测试的设备的UDID，创建完成后下载该文件并将它拖拽到Xcode中，以便后面的使用。</p>

<h2 id="实现">实现：</h2>

<p>打开Xcode并创建新的Single View Application iOS app。项目名称叫做voiptest并确保它的bundle identifier是<code class="language-plaintext highlighter-rouge">com.pengyu.voiptest</code>。bundle identifier非常重要，因为我们需要确保它的名称与我们的证书相同才可以发送推送。</p>

<p>添加PushkKit framework到我们的工程，General-&gt; Linked Frameworks and Libraries.
在Build Settings -&gt; Code Signing那里，provisioning profile选择刚才创建的AdHoc的profile，在Code Signing Identity选择Distribution模式。</p>

<p>在编写代码之前的最后一件事就是打开应用的Background Modes。我们可以在项目Target下的capabilities标签下找到。如下图所示：</p>

<p>在这个标签下有很多不同的选项，找到Background Modes并启用它。我们需要选定VoIP所需要的所有选项：</p>

<p><code class="language-plaintext highlighter-rouge">Audio and Airplay</code></p>

<p><code class="language-plaintext highlighter-rouge">Voice over IP</code></p>

<p><code class="language-plaintext highlighter-rouge">Remote notifications</code></p>

<p>现在我们开始向项目中添加代码。打开<code class="language-plaintext highlighter-rouge">AppDelegate.swift</code>，导入PushKit并注册通知。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import UIKit
import PushKit
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@UIApplicationMain
class AppDelegate: UIResponder, UIApplicationDelegate {
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>var window: UIWindow?
let voipRegistry = PKPushRegistry(queue: dispatch_get_main_queue())</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>func application(application: UIApplication, didFinishLaunchingWithOptions launchOptions: [NSObject: AnyObject]?) -&gt; Bool {
  // Override point for customization after application launch.
  //Enable all notification type. VoIP Notifications don’t present a UI but we will use this to show local nofications later
  let notificationSettings = UIUserNotificationSettings(forTypes: [UIUserNotificationType.Alert, UIUserNotificationType.Badge, UIUserNotificationType.Sound] , categories: nil)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>//register the notification settings
  application.registerUserNotificationSettings(notificationSettings)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>//output what state the app is in. This will be used to see when the app is started in the background
  NSLog(“app launched with state (application.applicationState.stringValue)”)
  return true
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>func applicationWillTerminate(application: UIApplication) {
  // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.
  //output to see when we terminate the app
  NSLog(“app terminated”)
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>这里我们使用一些Log输出来查看我们的应用是否正常工作。这将使我们在控制台观测到程序在后台运行时收到通知的反应。</p>

<p>我们使用了<code class="language-plaintext highlighter-rouge">registerUserNotificationSettings</code>方法，我们还需要实现它的delegate callback <code class="language-plaintext highlighter-rouge">didRegisterUserNotificationSettings</code>.</p>

<p>在这个回调中我们会在用户同意接收推送的情况下注册VoIP通知推送。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension AppDelegate {
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func application(application: UIApplication, didRegisterUserNotificationSettings notificationSettings: UIUserNotificationSettings) {
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>//register for voip notifications
  NSLog(“didRegisterUserNotificationSettings called”)
  voipRegistry.desiredPushTypes = Set([PKPushTypeVoIP])
  voipRegistry.delegate = self;</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  }
}
</code></pre></div></div>

<p>我们刚刚在<code class="language-plaintext highlighter-rouge">voipRegistry</code>对象声明中启用了VoIP推送。初始化<code class="language-plaintext highlighter-rouge">PKPushRegistry</code>将使用一个GCD队列来决定它的delegates从哪里回调。这里我们使用主队列，因为在这个简单的测试中并没有什么关系。要想实现<code class="language-plaintext highlighter-rouge">voipRegistry</code>对象的作用，我们需要设置它的delegate为 <code class="language-plaintext highlighter-rouge">.self</code>。<code class="language-plaintext highlighter-rouge">voipRegistry</code>的delegate是一个具有三个方法的<code class="language-plaintext highlighter-rouge">PKPushRegistryDelegate</code>类型，其中两个是必须的，下面我们添加这些方法到我们的项目中。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension AppDelegate: PKPushRegistryDelegate {
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func pushRegistry(registry: PKPushRegistry!, didUpdatePushCredentials credentials: PKPushCredentials!, forType type: String!) {
</code></pre></div></div>
<p>NSLog(“didUpdatePushCredentials called”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>//print out the VoIP token. We will use this to test the nofications.
  NSLog(“voip token: (credentials.token)”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func pushRegistry(registry: PKPushRegistry!, didReceiveIncomingPushWithPayload payload: PKPushPayload!, forType type: String!) {
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>NSLog(“didReceiveIncomingPushWithPayload called”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>let payloadDict = payload.dictionaryPayload[“aps”] as? Dictionary&lt;String, String&gt;
  let message = payloadDict?[“alert”]</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>//present a local notifcation to visually see when we are recieving a VoIP Notification
  if UIApplication.sharedApplication().applicationState == UIApplicationState.Background {</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSLog("incoming notificaiton from background")
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let localNotification = UILocalNotification();
localNotification.alertBody = message
localNotification.applicationIconBadgeNumber = 1;
localNotification.soundName = UILocalNotificationDefaultSoundName;
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UIApplication.sharedApplication().presentLocalNotificationNow(localNotification);
</code></pre></div></div>
<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>else {</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSLog("incoming notificaiton from frontend")
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_async(dispatch_get_main_queue(), { () -&gt; Void in
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let alertController = UIAlertController(title: "Title", message: "This is UIAlertController default", preferredStyle: UIAlertControllerStyle.Alert)
let cancelAction = UIAlertAction(title: "Cancel", style: UIAlertActionStyle.Cancel, handler: nil)
let okAction = UIAlertAction(title: "OK", style: UIAlertActionStyle.Default, handler: nil)
alertController.addAction(cancelAction)
alertController.addAction(okAction)
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UIApplication.sharedApplication().keyWindow?.rootViewController?.presentViewController(alertController, animated: true, completion: nil)
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>})
</code></pre></div></div>
<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
<p>NSLog(“incoming voip notfication: (payload.dictionaryPayload)”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func pushRegistry(registry: PKPushRegistry!, didInvalidatePushTokenForType type: String!) {
</code></pre></div></div>
<p>NSLog(“didInvalidatePushTokenForType called”)
  NSLog(“token invalidated”)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  }
}
</code></pre></div></div>

<p>我们不需要添加额外的代码到这些方法中去，但对于我们的测试，我们将使用<code class="language-plaintext highlighter-rouge">UILocalNotification</code>或者<code class="language-plaintext highlighter-rouge">UIAlertController</code>来显示收到了VoIP推送通知。我们还打印出<code class="language-plaintext highlighter-rouge">token</code>因为我们后面需要用它来测试我们的功能。好了，现在我们的程序将会在后台收到消息是重新打开应用程序了。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extension UIApplicationState {
</code></pre></div></div>
<p>//help to output a string instead of an enum number
var stringValue : String {</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get {
    switch(self) {
    case .Active:
        return "Active"
    case .Inactive:
        return "Inactive"
    case .Background:
        return "Background"
    }
}
</code></pre></div></div>
<p>}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<h2 id="测试">测试</h2>

<p>编写完代码之后，打包（Archive）项目并导出ipa文件，然后安装到测试设备上（可以通过iTunes安装）。</p>

<p>运行App，我们可以在devices viewer（Xcode &gt; Window &gt; Devices）中查看设备的Log：在左侧选择正确的设备并点击底部的log部分。
进入log之后可以使用 <code class="language-plaintext highlighter-rouge">Command＋F</code> 查找关键字app launched with state或voip token，应当得到类似如下的输出：</p>

<center><img src="/images/voip/image12.png" alt="" width="80%" /></center>

<p>复制你得到的token并将其保存在剪贴板上，后面会用到。</p>

<p>现在回到你存储证书的那个文件夹，应该包含有下面的文件：</p>

<p><code class="language-plaintext highlighter-rouge">voip_services.cer</code></p>

<p><code class="language-plaintext highlighter-rouge">certificate.p12</code></p>

<p>1 - 打开终端，通过certificate文件创建pem文件。</p>

<p><code class="language-plaintext highlighter-rouge">openssl x509 -in voip_services.cer -inform der -out PushVoipCert.pem</code></p>

<p>2 - 通过导出的private key文创建另一个pem文件，其过程中需要你创建一个密码用于验证。</p>

<p><code class="language-plaintext highlighter-rouge">openssl pkcs12 -nocerts -out PushVoipKey.pem -in certificate.p12</code></p>

<p>3 - 将两个文件和成为一个:</p>

<p><code class="language-plaintext highlighter-rouge">cat PushVoipCert.pem PushVoipKey.pem &gt; ck.pem</code></p>

<p>下载Simplepush的<a href="http://d1xzuxjlafny7l.cloudfront.net/downloads/SimplePush.zip">php脚本文件</a>用于发送推送消息。修改<code class="language-plaintext highlighter-rouge">$deviceToken</code>为你的Token，<code class="language-plaintext highlighter-rouge">$passphrase</code>为刚刚生成PushVoipKey.pem是所设置的密码。例如：</p>

<p><code class="language-plaintext highlighter-rouge">$deviceToken = 'b949d3784df30c2cf5c16aa24b494cb82c78acda986113b39e1b89b0a1f0d4bc';</code></p>

<p><code class="language-plaintext highlighter-rouge">$passphrase = 'password';</code></p>

<p>如果你使用的是Simplepush的代码，还要修改下面这一行：
将<code class="language-plaintext highlighter-rouge">ssl://gateway.sandbox.push.apple.com:2195</code>改成<code class="language-plaintext highlighter-rouge">ssl://gateway.push.apple.com:2195</code>。
这是因为我们需要使用Apple的产品状态服务器地址而不是开发状态服务器地址。</p>

<p>这里贴一下<code class="language-plaintext highlighter-rouge">simplepush.php</code>的脚本代码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Put your device token here (without spaces):
$deviceToken = 'b949d3784df30c2cf5c16aa24b494cb82c78acda986113b39e1b89b0a1f0d4bc';
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Put your private key's passphrase here:
$passphrase = 'password';
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Put your alert message here:
$message = 'My first push notification!';
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>////////////////////////////////////////////////////////////////////////////////
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ctx = stream_context_create();
stream_context_set_option($ctx, 'ssl', 'local_cert', 'ck.pem');
stream_context_set_option($ctx, 'ssl', 'passphrase', $passphrase);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Open a connection to the APNS server
$fp = stream_socket_client(
	'ssl://gateway.push.apple.com:2195', $err,
	$errstr, 60, STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT, $ctx);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (!$fp)
	exit("Failed to connect: $err $errstr" . PHP_EOL);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo 'Connected to APNS' . PHP_EOL;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Create the payload body
$body['aps'] = array(
	'alert' =&gt; $message,
	'sound' =&gt; 'default'
	);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Encode the payload as JSON
$payload = json_encode($body);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Build the binary notification
$msg = chr(0) . pack('n', 32) . pack('H*', $deviceToken) . pack('n', strlen($payload)) . $payload;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Send it to the server
$result = fwrite($fp, $msg, strlen($msg));
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (!$result)
	echo 'Message not delivered' . PHP_EOL;
else
	echo 'Message successfully delivered' . PHP_EOL;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Close the connection to the server
fclose($fp);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>?&gt;
</code></pre></div></div>

<p>执行脚本文件</p>

<p><code class="language-plaintext highlighter-rouge">php simplepush.php</code></p>

<p>你将在控制台看到消息发送成功的消息，如图：</p>

<center><img src="/images/voip/image14.png" alt="" width="80%" /></center>

<p>如果一切顺利，你将会在设备端收到相应UILocalNotification或UIAlertAction的推送消息，并且能够在Log中看到相应函数调用的输出。例如：</p>

<center><img src="/images/voip/image13.png" alt="" width="80%" /></center>

<p>P.S. 文中截图会略有不同，截自voiptest和coolpush两个项目，只是项目名称不同，不影响整体的理解。</p>



                <hr>

                <div class="license">
                    <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
                        <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
                    </a>
                    <br />
                    This work is licensed under a 
                    <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
                        Creative Commons Attribution-ShareAlike 4.0 International License
                    </a>.
                </div>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/linux-shell-programming.html" 
                           data-toggle="tooltip" 
                           data-placement="top" 
                           title="Linux Shell Programming / Linux Shell编程">
                            &larr; Previous Post
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/blog/notes-from-ctp.html" 
                           data-toggle="tooltip" 
                           data-placement="top" 
                           title="Notes from C Traps and Pitfalls / C陷阱与缺陷笔记">
                            Next Post &rarr;
                        </a>
                    </li>
                    
                </ul>

                
                <div id="disqus_thread"></div>
                <script>
                    var disqus_config = function () {
                        this.page.url = 'http://localhost:4000/blog/ios-voip-push-notification.html';
                        this.page.identifier = '/blog/ios-voip-push-notification';
                        this.page.title = 'Example of iOS VoIP Notification / iOS VoIP Notification实例';
                    };
                    (function() {
                        var d = document, s = d.createElement('script');
                        s.src = 'https://Shongsu.disqus.com/embed.js';
                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>
                    Please enable JavaScript to view the 
                    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
                        comments powered by Disqus.
                    </a>
                </noscript>
                
            </div>
        </div>
    </div>
</article>

<!-- Anchor.js for heading links -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js" integrity="sha512-nMyycQyP0XWqJq+1qXGmz0JHJ3xVxvn3l8wRjTRsc6yf2l5F3V4FV2cJNVh3y2FjOS1z7sY1X3cV1y2k3BH4l2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        anchors.options = {
            visible: 'always',
            placement: 'right',
            icon: '#'
        };
        anchors.add('.post-container h1, .post-container h2, .post-container h3, .post-container h4');
    });
</script>
<style>
    @media all and (min-width: 800px) {
        .anchorjs-link {
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top: -0.1em;
        }
    }
</style>

  
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml" aria-label="RSS Feed">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>

                    
                    <li>
                        <a href="https://linkedin.com/in/pengyu-chen-85253886" aria-label="LinkedIn" target="_blank" rel="noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li>
                        <a href="https://github.com/Shongsu" aria-label="GitHub" target="_blank" rel="noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li>
                        <a href="https://www.zhihu.com/people/Shongsu" aria-label="Zhihu" target="_blank" rel="noopener noreferrer">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-zhihu fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li>
                        <a href="mailto:chinhouu1992@gmail.com" aria-label="Email">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    &copy; 2015&ndash;2026 Pengyu. Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js"></script>

<!-- Syntax Highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wf8aEkv2Lz/Wz3i6/lmC4i8c1Qebfy3iM8guu1n9aTq7gire0xE/gl0fvJf/dJ1dg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" integrity="sha512-0a4y4Bj2EY2Y4WY4Q0S8pSAH8yiFgp8mF07rxBhFqFMj/4k3R0Af0xfY7s3waR0LfVH2B1cDi0F1EBfYEUhg+yw==" crossorigin="anonymous" referrerpolicy="no-referrer">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        hljs.highlightAll();
    });
</script>


</body>

</html>